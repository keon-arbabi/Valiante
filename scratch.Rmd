---
title: "scratch"
author: "Keon Arbabi"
date: "03/03/2022"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# load libraries 
```{r}
suppressPackageStartupMessages({
  library(tidyverse)
  library(GEOquery)
  library(limma)
  library(HelpersMG)
  library(Seurat)
  library(glmGamPoi)
  library(matrixStats)
  library(ggpubr)
  library(ggbeeswarm)
})
```

# download data
```{r}
if(F){
  wget(c("http://pklab.med.harvard.edu/viktor/publications/Epilepsy19/count_matrices.rds",
         "http://pklab.med.harvard.edu/viktor/publications/Epilepsy19/con_filt_cells.rds",
         "http://pklab.med.harvard.edu/viktor/publications/Epilepsy19/con_filt_samples.rds"))
}
```

# functions
```{r}
convertMouseGeneList = function(x){
  require("biomaRt")
  human = useMart("ensembl", dataset = "hsapiens_gene_ensembl", host = "https://dec2021.archive.ensembl.org/")
  mouse = useMart("ensembl", dataset = "mmusculus_gene_ensembl", host = "https://dec2021.archive.ensembl.org/")
  genesV2 = getLDS(attributes = c("mgi_symbol"), filters = "mgi_symbol", values = x , mart = mouse, attributesL = c("hgnc_symbol"), martL = human, uniqueRows=T)
  mousex = unique(genesV2[, 2])
  # Print the first 6 genes found to the screen
  print(head(mousex))
  return(genesV2)
}
```

# prepare data 
```{r}
# read sample metadata
samples_metadata = read.csv(url("https://raw.githubusercontent.com/khodosevichlab/Epilepsy19/master/metadata/sample_info.csv")) %>%
  mutate(Condition = case_when(Alias %in% c("C1","C2","C3","C4","C5","C6","C7","C8","C9","C10") ~ "Control",
                               Alias %in% c("E1","E2","E3","E4","E5","E6","E7","E8","E9") ~ "Epilepsy"))
# read cell annotation metadata 
annot_metadata = read.csv(url("https://raw.githubusercontent.com/khodosevichlab/Epilepsy19/master/metadata/annotation.csv"))
rownames(annot_metadata) = annot_metadata$cell

# read counts
counts_lst = readRDS(file = "./input/count_matrices.rds")
counts_lst = counts_lst[names(counts_lst) != "NeuN"]
# get number of cells from each subject and add to metadata
samps = lapply(counts_lst, function(x){
  return(data.frame(cells = ncol(x)))
})
samps = do.call(rbind, samps) %>% rownames_to_column(var = "Name")
samples_metadata = samples_metadata[match(samps$Name, samples_metadata$Name),]
samples_metadata$N_cells = samps$cells
rownames(samples_metadata) = NULL
samps = c(rep(samps[,1], times = samps[,2]))

# convert to sparse matrix
counts_matrix = do.call(cbind, counts_lst)
dim(counts_matrix)
cells = colnames(counts_matrix)
# rename columns using unique sample id
colnames(counts_matrix) = paste(samps, cells, sep = "_")

# combine metadata
samples_metadata = samples_metadata[rep(1:nrow(samples_metadata), samples_metadata$N_cells),]
samples_metadata$cell = colnames(counts_matrix)
metadata = left_join(annot_metadata, samples_metadata, by = "cell")
rownames(metadata) = metadata$cell

# filter to match annotation metadata 
counts_matrix = counts_matrix[,colnames(counts_matrix) %in% metadata$cell]
dim(counts_matrix)
metadata = metadata %>% filter(cell %in% colnames(counts_matrix))

# create Seurat object
seu_obj = CreateSeuratObject(counts = counts_matrix, meta.data = metadata)
head(x = rownames(x = seu_obj))
head(x = colnames(x = seu_obj))

# # normalize
# # https://doi.org/10.1186/s13059-019-1874-1
# seu_obj = SCTransform(seu_obj, method = "glmGamPoi", verbose = TRUE)
# # save Seurat object
# saveRDS(seu_obj, file = "./output/seu_obj.rds")

```

# calculate expression stdev and mean within cell types
```{r}
# load normalized Seurat object 
seu_obj_norm = readRDS(file = "./output/seu_obj_norm.rds")
table(metadata$Name, metadata$l2)
# remove subject with low cell counts 
seu_obj_norm = subset(seu_obj_norm, subset = Name == "HB51", invert = TRUE)
metadata = metadata %>% filter(!Name == "HB51")
# initialize
res = NULL

# split cells by subclass and subject
# this amounts to calculating intra-individual variability within cells types 
for(CT in unique(metadata$l2)){
  for(INDV in unique(metadata$Name)){
    # subset
    seu_tmp = subset(seu_obj_norm, subset = l2 == CT & Name == INDV)
    # get normalized expression matrix (Pearson residuals)
    # NOTE: only 3000 variable genes are stored (residuals are non-zero and therefore can't be save in a sparse matrix)
    sct_matrix = seu_tmp@assays$SCT@scale.data %>% as.matrix() 
    dim(sct_matrix)
    # get model attributes
    # use this instead because the mean and variance of the residuals are available for every gene 
    sct_model_df = seu_tmp@assays$SCT@SCTModel.list$model1@feature.attributes
    
    # get gene-wise coefficient of variation (Stdev/Mean*100)
    tmp = data.frame(Name = INDV,
                     Gene = rownames(sct_model_df),
                     Mean = sct_model_df$residual_mean,
                     Stdev = sqrt(sct_model_df$residual_variance)) %>%
      mutate(CV = Stdev/(Mean*100))
    # save
    res = rbind(res, tmp)
    # visualize gene mean-variance relationship
    sct_model_df %>%
      as.data.frame() %>%
      ggplot(., aes(x = log10(gmean), y = residual_variance)) +
      geom_point(alpha = 0.5, fill = "grey", colour = "black") +
      geom_density_2d(size = 0.3) +
        labs(x = "Log10(Geometric Mean)", 
             y = "Residual variance") +
        ggtitle("Gene Mean-Variance Relationship") 
    ggsave(filename = paste0("./output/figures/qc/sct_",INDV,"_",CT,".jpeg"), width = 6, height = 5.5)
  }
}
res = left_join(res, distinct(samples_metadata[,-(6:7)]), by = "Name")
summary(res$CV)
# save results 
write.csv(res, file = "./output/res.csv")

```

# visualize
```{r}
# load 
res = read.csv(file = "./output/res.csv") %>% column_to_rownames(var = "X")

# get genes significantly associated with membrane potential and rheobase
select_genes = read.csv(file = "./input/Tripathy_2017_ephys_genes.csv")[,-1] %>%
  dplyr::rename(MGI.symbol = GeneSymbol)
# convert mouse genes 
hgnc = convertMouseGeneList(select_genes$MGI.symbol)
# filter
select_genes = left_join(select_genes, hgnc, by = "MGI.symbol") 
select_genes = select_genes %>% filter(EphysProp %in% c("Vrest","Rheo")) %>% pull(HGNC.symbol)

# get same number of random, protein-coding genes for comparison
mart = biomaRt::useMart(biomart = "ensembl", dataset = "hsapiens_gene_ensembl")
protein_genes = biomaRt::getBM(attributes = c("hgnc_symbol", "gene_biotype"), filters = c("hgnc_symbol", "biotype"), values = list(unique(res$gene), "protein_coding"), mart = mart)
random_genes = intersect(res$gene, protein_genes$hgnc_symbol) %>% sample(.,length(select_genes), replace = FALSE)

res_select_control = res %>% filter(gene %in% select_genes, condition == "Control") 
res_select_epilepsy = res %>% filter(gene %in% select_genes, condition == "Epilepsy") 

# mean-sd plot colored by condition for ephys associated genes 
res %>%
  ggplot(aes(x = mean, y = sd)) +
  geom_point(alpha = 0.1, shape = 16) +
  geom_point(data = res_select_control, aes(x = mean, y = sd), color = "darkgreen", alpha = 0.5, size = 2, shape = 16) +
  geom_point(data = res_select_epilepsy, aes(x = mean, y = sd), color = "darkorange", alpha = 0.5, size = 2, shape = 16) +
  labs(x = "mean normalized expression", y = "expression standard deviation") +
  theme_classic()
#ggsave(filename = paste0("./output/figures/ephy_genes_meansd.jpeg"), width = 9, height = 5)

# compare expression sd 
res %>%
  mutate(ephys_gene = case_when(gene %in% select_genes ~ "Vrest & rheobase associated genes", 
                                gene %in% random_genes ~ "Random protein-coding genes",
                                TRUE ~ "All genes")) %>% 
  mutate(ephys_gene, factor(ephys_gene)) %>%
  ggplot(aes(x = condition, y = sd)) + 
  geom_boxplot(aes(fill = condition)) +
  scale_fill_manual(breaks = c("Control","Epilepsy"), values = c("darkgreen","darkorange")) +
  labs(x = "condition", y = "standard deviation of expression") +
  coord_flip() +
  facet_wrap(~ephys_gene, ncol = 1) +
  theme_classic() +
  theme(legend.position = "none") +
  stat_compare_means(method = "wilcox", aes(group = condition), label.y = 1, label.x = 0.6, size = 3)
#ggsave(filename = paste0("./output/figures/ephy_genes_sdboxplots.jpeg"), width = 9, height = 6)

# compare expression sd by CT
res %>%
  mutate(ephys_gene = case_when(gene %in% select_genes ~ "Vrest & rheobase associated genes", 
                                gene %in% random_genes ~ "Random protein-coding genes",
                                TRUE ~ "All genes")) %>% 
  #filter(gene %in% select_genes) %>%
  ggplot(aes(x = condition, y = mean)) + 
  geom_boxplot(aes(fill = condition), outlier.shape = NA) +
  geom_quasirandom(na.rm = T, shape = 16, alpha = 0.1) + 
  scale_fill_manual(breaks = c("Control","Epilepsy"), values = c("darkgreen","darkorange")) +
  labs(x = "condition", y = "standard deviation of expression") +
  coord_flip() +
  facet_grid(cell_type ~ ephys_gene, scales = "free") +
  theme_classic() +
  theme(legend.position = "none") +
  stat_compare_means(ref.group = "Control", label = "p.signif", method = "wilcox", label.y = 0.8) 
ggsave(filename = paste0("./output/figures/ephy_genes_sdboxplots2.jpeg"), width = 9, height = 12)

  
```












