---
title: "scratch"
author: "Keon Arbabi"
date: "03/03/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# load libraries 
```{r}

suppressPackageStartupMessages({
  library(tidyverse)
  library(GEOquery)
  library(limma)
  library(HelpersMG)
  library(Seurat)
  library(matrixStats)
  library(ggpubr)
})
```

# download data
```{r}

if(F){
  wget(c("http://pklab.med.harvard.edu/viktor/publications/Epilepsy19/count_matrices.rds",
         "http://pklab.med.harvard.edu/viktor/publications/Epilepsy19/con_filt_cells.rds",
         "http://pklab.med.harvard.edu/viktor/publications/Epilepsy19/con_filt_samples.rds"))
}
```

# functions
```{r}

convertMouseGeneList = function(x){
  require("biomaRt")
  human = useMart("ensembl", dataset = "hsapiens_gene_ensembl")
  mouse = useMart("ensembl", dataset = "mmusculus_gene_ensembl")
  genesV2 = getLDS(attributes = c("mgi_symbol"), filters = "mgi_symbol", values = x , mart = mouse, attributesL = c("hgnc_symbol"), martL = human, uniqueRows=T)
  mousex = unique(genesV2[, 2])
  # Print the first 6 genes found to the screen
  print(head(mousex))
  return(genesV2)
}
```

# prepare data 
```{r}

# read sample metadata
samples_metadata = read.csv(file = "./input/sample_info.csv") %>%
  mutate(Condition = case_when(Alias %in% c("C1","C2","C3","C4","C5","C6","C7","C8","C9","C10") ~ "Control",
                               Alias %in% c("E1","E2","E3","E4","E5","E6","E7","E8","E9") ~ "Epilepsy"))
# read cell annotation metadata 
annot_metadata = read.csv(file = "./input/annotation.csv")
rownames(annot_metadata) = annot_metadata$cell

# read counts
counts_lst = readRDS(file = "./input/count_matrices.rds")
counts_lst = counts_lst[names(counts_lst) != "NeuN"]

samps = lapply(counts_lst, function(x){
  return(data.frame(cells = ncol(x)))
})
samps = do.call(rbind, samps) %>% rownames_to_column(var = "Name")
samples_metadata = samples_metadata[match(samps$Name, samples_metadata$Name),]
samples_metadata$N_cells = samps$cells
rownames(samples_metadata) = NULL
samps = c(rep(samps[,1], times = samps[,2]))

# convert to sparse matrix
counts_matrix = do.call(cbind, counts_lst)
dim(counts_matrix)
cells = colnames(counts_matrix)

# rename columns using unique sample id
colnames(counts_matrix) = paste(samps, cells, sep = "_")

# combine metadata
samples_metadata = samples_metadata[rep(1:nrow(samples_metadata), samples_metadata$N_cells),]
samples_metadata$cell = colnames(counts_matrix)
metadata = left_join(annot_metadata, samples_metadata, by = "cell")
rownames(metadata) = metadata$cell

# filter to match annotation metadata 
counts_matrix = counts_matrix[,colnames(counts_matrix) %in% metadata$cell]
metadata = metadata %>% filter(cell %in% colnames(counts_matrix))

# create Seurat object 
seu_obj = Seurat::CreateSeuratObject(counts = counts_matrix,
                                     meta.data = metadata)
head(x = rownames(x = seu_obj))
head(x = colnames(x = seu_obj))

# # visualize QC metrics as a violin plot
# seu_obj[["percent.mt"]] = PercentageFeatureSet(seu_obj, pattern = "^MT-")
# VlnPlot(seu_obj, features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), ncol = 3, pt.size = 0)
# # save Seurat object 
# saveRDS(seu_obj, file = "./output/seu_obj.rds")

```

# calculate expression stdev and mean within cell types
```{r}

# reload Seurat object from above 
#seu_obj = readRDS(file = "./output/seu_obj.rds")

if(F){
  for(disorder in unique(metadata$Condition)){
    for(CT in unique(metadata$l2)){
      # subset by combination of condition and cell type 
      seu_tmp = subset(seu_obj, subset = Condition == disorder & l2 == CT)
      # get normalized and variance-stabilized expression 
      # https://doi.org/10.1186/s13059-019-1874-1
      seu_tmp = SCTransform(seu_tmp, verbose = FALSE)
      # get un-normalized counts
      unnorm_matrix = seu_tmp@assays$RNA@counts %>% as.matrix()
      # visualize mean-variance relationship 
      p1 = unnorm_matrix %>%
        as.data.frame() %>% 
        rownames_to_column("gene") %>% 
        pivot_longer(cols = - gene, names_to = "sample", values_to = "counts") %>% 
        dplyr::group_by(gene) %>% 
        dplyr::summarise(gene_average = mean(counts), gene_stdev = sd(counts)) %>% 
        ungroup() %>%
        ggplot(., aes(x = log10(gene_average), y = log10(gene_stdev))) +
          geom_point(alpha = 0.5, fill = "grey", colour = "black") +
          labs(x = "Gene count average (log10)", 
               y = "Gene count standard deviation (log10)") +
          ggtitle("Mean - Standard deviation relationship")

      rm(unnorm_matrix)
      gc()
      
      # get normalized expression 
      sct_matrix = seu_tmp@assays$SCT@data %>% as.matrix()
      # visualize mean-variance relationship 
      p2 = sct_matrix %>%
        as.data.frame() %>% 
        rownames_to_column("gene") %>% 
        pivot_longer(cols = - gene, names_to = "sample", values_to = "counts") %>% 
        dplyr::group_by(gene) %>% 
        dplyr::summarise(gene_average = mean(counts), gene_stdev = sd(counts)) %>% 
        ungroup() %>%
        ggplot(., aes(x = gene_average, y = gene_stdev)) +
        geom_point(alpha = 0.5, fill = "grey", colour = "black") +
          labs(x = "Gene count average", 
               y = "Gene count standard deviation") +
          ggtitle("Mean - Standard deviation relationship")
      ggarrange(p1, p2, nrow = 1)
      ggsave(filename = paste0("./output/figures/sct_",disorder,"_",CT,".jpeg"), width = 11, height = 5.5)
      
      # initialize if first loop      
      if(disorder == "Control" & CT == "Vip"){
        res = data.frame(gene = rownames(sct_matrix),
                         mean = rowMeans(sct_matrix),
                         sd = rowSds(sct_matrix),
                         cell_type = CT,
                         condition = disorder)
      } else {
        tmp = data.frame(gene = rownames(sct_matrix),
                         mean = rowMeans(sct_matrix),
                         sd = rowSds(sct_matrix),
                         cell_type = CT,
                         condition = disorder)
        res = rbind(res, tmp)
      }
      rm(sct_matrix)
      gc()
      print(CT)
    }
    print(disorder)
  }
}
#write.csv(res, file = "./output/res.csv")

```

```{r}

res = read.csv(file = "./output/res.csv")

# get genes significantly associated with membrane potential and rheobase
select_genes = read.csv(file = "./input/Tripathy_2017_ephys_genes.csv")[,-1] %>%
  dplyr::rename(MGI.symbol = GeneSymbol)
# convert mouse genes 
hgnc = convertMouseGeneList(select_genes$MGI.symbol)
# filter
select_genes = left_join(select_genes, hgnc, by = "MGI.symbol") 
select_genes = select_genes %>% filter(EphysProp %in% c("Vrest","Rheo")) %>% pull(HGNC.symbol)

# same number of random genes for comparison
random_genes = res %>% sample_n(length(select_genes)) %>% pull(gene)

res_select_control = res %>% filter(gene %in% select_genes, condition == "Control") 
res_select_epilepsy = res %>% filter(gene %in% select_genes, condition == "Epilepsy") 

# mean-sd plot colored by condition for ephys associated genes 
res %>%
  ggplot(aes(x = mean, y = sd)) +
  geom_point(alpha = 0.1, shape = 16) +
  geom_point(data = res_select_control, aes(x = mean, y = sd), color = "darkgreen", alpha = 0.5, size = 2, shape = 16) +
  geom_point(data = res_select_epilepsy, aes(x = mean, y = sd), color = "darkorange", alpha = 0.5, size = 2, shape = 16) +
  labs(x = "mean normalized expression", y = "expression standard deviation") +
  theme_classic()
ggsave(filename = paste0("./output/figures/ephy_genes_meansd.jpeg"), width = 9, height = 5)

# compare expression sd 
res %>%
  mutate(ephys_gene = case_when(gene %in% select_genes ~ "Vrest & rheobase associated genes", 
                                gene %in% random_genes ~ "Random genes",
                                TRUE ~ "All genes")) %>% 
  mutate(ephys_gene, factor(ephys_gene)) %>%
  ggplot(aes(x = condition, y = sd)) + 
  geom_boxplot(aes(fill = condition)) +
  scale_fill_manual(breaks = c("Control","Epilepsy"), values = c("darkgreen","darkorange")) +
  labs(x = "condition", y = "standard deviation of expression") +
  coord_flip() +
  facet_wrap(~ephys_gene, ncol = 1) +
  theme_classic() +
  theme(legend.position = "none") +
  stat_compare_means(method = "wilcox", aes(group = condition), label.y = 1, label.x = 0.6, size = 3)
ggsave(filename = paste0("./output/figures/ephy_genes_sdboxplots.jpeg"), width = 9, height = 6)

  
```












